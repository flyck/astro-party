---
import {db, Participants, eq} from "astro:db";
import Input from "../../../components/mini/input.astro"
import SubmitButton from "../../../components/submitButton.astro"
import {toastResponse, ToastError} from "../../../components/toast.astro"
import Modal from "../../../layouts/Modal.astro"

const { request } = Astro

let participants = []
try {
  const url = new URL(request.headers.get("Hx-Current-Url") || "")
  const id = url.pathname.split("/")[1] || ""

  if (!id ) {
    throw new ToastError("warning", "Bad request", 400)
  }

  participants = await db.select().from(Participants).where(eq(Participants.partyId, id));
} catch(error) {
  if (error instanceof ToastError) {
    return toastResponse(error)
  }
  return toastResponse(new ToastError("error", "Something went wrong. :(", 500))
}
---
<ul id="openModal">
  {participants.map((p) =>
  <button id={p.id.toString()} class="border-b border-gray-500 p-2 w-full text-left text-sm"
          data-id={p.id.toString()} data-name={p.name} data-email={p.email}>
      {p.name} ({p.email || "?"})
  </button>
  )}
</ul>

<Modal id="myModal" title="Edit Participant" buttonId="openModal">
  <form
    hx-post="/server/participant/update"
    hx-swap="none"
    >
    <Input id="modal-id" name="id" title="Id" class="hidden" type="text" value="init"></Input>
    <Input id="modal-name" name="name" title="Name" type="text" value="init"></Input>
    <Input id="modal-email" name="email" title="Email" type="text" value="init" ></Input>

  <div class="p-2">
    <button
      aria-label="Delete"
      class="bg-red-600 text-gray-100 rounded-sm w-full"
      hx-post="/server/participant/delete"
      hx-swap="none"
      type="button"
    >
      -
    </button>
  </div>

    <SubmitButton>Ok</SubmitButton>
  </form>
</Modal>

<script>
    // Get the item list
    var itemList = document.getElementById('openModal')!;

    // When a list item is clicked, open the modal with the corresponding content
    itemList.addEventListener('click', function(e) {
      var id = e.target?.getAttribute('data-id');
      var name = e.target?.getAttribute('data-name');
      var email = e.target?.getAttribute('data-email');
      document.getElementById('modal-id')!.value = id;
      document.getElementById('modal-name')!.value = name;
      document.getElementById('modal-email')!.value = email;
    });
</script>
